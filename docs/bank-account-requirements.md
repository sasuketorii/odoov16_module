## 銀行口座登録モジュール 要件定義（日本）

### 目的とスコープ
- **目的**: 日本の実務で利用する銀行口座情報を、最小項目で正確に登録・参照する。
- **対象**: 取引先（顧客/仕入先/自社）に紐づく銀行口座。
- **非目的**: 海外送金・SWIFT・ゆうちょ記号番号の自動変換など拡張要素。

### 最小データ項目（必須）
- **銀行マスタ（銀行名）**: `res.bank` を選択
- **支店番号（支店名）**: 3桁（支店名は自動補完可）
- **口座種類**: 普通 / 当座 / 貯蓄 / 定期 / その他
- **口座番号**: 7桁（不足分はゼロ埋め）
- **口座名義人（カナのみ）**: 半角カナに自動変換

### 画面仕様（`res.partner.bank` フォーム）
- 表示順:
  1. 銀行（`res.bank` 検索）
  2. 支店番号（3桁）／支店名（任意）
  3. 口座種類（選択）
  4. 口座番号（7桁、ゼロ埋め）
  5. 口座名義人（カナ、半角自動変換）
- 挙動:
  - 銀行選択時に支店候補を銀行でドメイン絞込。
  - 支店選択時に支店番号/支店名を自動反映。
  - 口座番号は入力完了時に`zfill(7)`。
  - 名義カナは全角→半角へ自動変換。

### バリデーション
- **支店番号**: `^[0-9]{3}$`
- **口座番号**: `^[0-9]{7}$`（不足は自動ゼロ埋めの上で検証）
- **名義カナ**: `^[ｱ-ﾝﾞﾟｧ-ｫｬｭｮｯｰ\s\-\(\)0-9A-Z]+$`
- 必須: 銀行 / 支店番号 / 口座種類 / 口座番号 / 名義カナ

### 銀行マスタ連携
- **目的**: 日本の銀行名と支店データをマスタとして保持し、選択で正確な登録を支援。
- **データ元（推奨）**: 全銀コードのオープンデータ（例: [Zengin Code GitHub](https://zengin-code.github.io/)）
- **モデル構成**:
  - `res.bank`（既存活用）
    - 追加: `jpBankCode(Char4)`, `bankNameKana(Char)`
  - `jp.bank.branch`（新規）
    - `bankId(Many2one->res.bank)`
    - `branchCode(Char3)` / `branchName(Char)` / `branchNameKana(Char)`
    - 一意制約: `(bankId, branchCode)`
- **規模目安**: 約1,300銀行 / 約25,000支店（Odoo標準で運用可能）
- **投入/更新**:
  - 管理者ウィザード「銀行マスタ更新」
    - 入力: JSON/CSVファイル or URL
    - 動作: Upsert（1000件チャンク）、インデックス付与
  - 更新頻度: 月1回程度（任意）
- **フォーム連携**:
  - 銀行選択 → 支店ドロップダウン（`bankId`ドメイン）
  - 支店選択で支店番号・支店名を自動反映

### 検索・一覧
- 一覧列: 銀行名 / 支店番号 / 口座種類 / 口座番号（末尾4桁のみ表示可） / 取引先
- 検索: 銀行名・支店番号・口座番号（部分一致）

### セキュリティ/監査
- 権限: 一般ユーザは自社レコードの参照/登録/更新、銀行マスタは管理者のみ編集可。
- 監査: 変更履歴をチャッターへ記録。口座番号はメッセージでマスク（例: `*******1`）。

### 非機能/品質
- 表示・入力は日本語。変換・検証はクライアント/サーバ双方で実施。
- パフォーマンス: 支店3万件規模でも検索はドメイン＋索引で良好。
- テスト: 変換/検証/ビューの単体テスト（Coverage 80%以上）。
- Lint: 警告ゼロ（CIで実行）。

### 非スコープ（当面実装しない）
- ゆうちょ記号番号→通常口座変換
- SWIFT/ABA等の海外送金属性
- 銀行の分類UI（都市/地方/信用金庫 等）

### 受け入れ基準（抜粋）
- 必須5項目のみで登録できる。
- 口座番号が7桁に自動整形される。
- 名義カナが全角入力でも半角に正規化される。
- 銀行→支店の選択連動が正しく動く。
- 一覧/検索要件を満たす。
- 権限/監査要件を満たす（マスク表示含む）。

### マイグレーション/互換
- 互換エイリアス `jp_account_number -> acc_number` は段階的に廃止（移行完了後削除）。
- 既存口座データは支店番号/支店名の整備を追加実施。

### 今後の拡張（任意）
- 口座重複検出（同一取引先＋銀行＋支店＋口座番号）
- CSV一括インポートUI
- 支払方法へのデフォルト口座関連付け

### 用語
- 全銀コード: 銀行コード4桁＋支店コード3桁の標準コード体系。 