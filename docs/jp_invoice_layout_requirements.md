# 日本向け請求書レイアウト要件定義（2025-10-13 更新）

提供されたリファレンスレイアウト（青基調の請求書）を基に、Odoo 16 モジュール `acoona_l10n_jp_invoice_system` が生成すべき最終成果物を定義する。

## 1. レイアウト概要

1. **タイトル帯**
   - A4縦、上端 25 mm 幅のブルーバー（基準色 `#0F4CC6`）。中央に白抜きで「請求書」。
2. **ヘッダー左右ブロック**
   - 左: 請求先情報。敬称「御中」を含め行頭に表示。住所は 2 行以内。リード文「下記の通り、ご請求申し上げます。」を続ける。
   - 左中央: 税込請求金額の強調ボックス（ラベル「ご請求金額（税込）」＋金額）。背景 `#2F6AE3`、金額は 24pt。
   - 右: 発行者情報。発行日 (`invoice_date`)、請求書番号 (`name`)、登録番号 (`company_id.l10n_jp_registration_number`)、会社名、住所、電話、メール。値は右揃え。
3. **支払情報ブロック**
   - 枠線付きボックスで「振込先」「振込期日」「備考」を縦に配置。左肩にブルーラベル。振込先欄は銀行名・支店名・種別・口座番号・名義を 2 行以内で表示。
4. **明細テーブル**
   - 列: `日付` / `内容` / `軽減税率`※ / `数量` / `単位` / `単価（税抜）` / `税率` / `金額（税抜）`。
   - 1 行目にヘッダー。背景 `#0F4CC6`、文字白。2 行目以降は白地に 0.5pt グリッド。行数は 15 行固定で不足分は罫線のみ表示。
5. **税率別内訳テーブル**
   - 左下に 2 列×3 行程度の表。「税率区分」「消費税」「金額（税抜）」を列とし、税率別に集計。ヘッダーはブルー背景。
6. **合計ボックス**
   - 右下に 3 行（小計 / 消費税 / 合計）。背景ブルー、金額は右寄せ白文字。
7. **備考欄**
   - ページ最下部にブルー枠の空欄（高さ 40 mm）。背景は白、枠色 `#0F4CC6`。

## 2. データマッピング

| レイアウト要素 | 表示例 | Odoo フィールド | 備考 |
| --- | --- | --- | --- |
| タイトル | 請求書 | 定数 | QWeb にて固定文字 |
| 請求先名称 | ○○○○株式会社 御中 | `partner_id.commercial_company_name or partner_id.display_name` | 敬称は設定値（デフォルト「御中」）を後置 |
| 請求先住所 | 〒～ | `partner_id._display_address()` | 改行 `<br/>` で整形 |
| ご請求金額（税込） | ¥119,800 | `amount_total` | 日本円フォーマット `format_amount` |
| 発行日 | 2023/1/1 | `invoice_date` | 不在時 `fields.Date.today()` |
| 請求書番号 | 0000001 | `name` | draft は `draft_name` |
| 登録番号 | T012345... | `company_id.l10n_jp_registration_number` | 13 桁未満時は警告表示 |
| 自社住所等 | 住所、電話、メール | `company_id` 関連フィールド | 電話・メールは空の場合非表示 |
| 振込先 | ○○銀行 ○○支店 普通口座 0123456 ○○○○（ﾌﾘｶﾞﾅ） | `company_id.l10n_jp_default_invoice_bank_id` | 未設定時は全行非表示 |
| 振込期日 | 2023年2月末 | `invoice_date_due` | `format_date` で和式表示 |
| 明細: 日付 | 2022/12/1 | `invoice_line_ids.date` または `invoice_line_ids.move_id.invoice_date` | 不在時空欄 |
| 明細: 内容 | AAAA | `invoice_line_ids.name` | 改行は `<br/>` |
| 明細: 軽減税率 | ※（軽減対象） | `tax_line.tax_group_id.is_reduced` 判定 | 軽減の場合「※」、それ以外は空欄 |
| 明細: 数量/単位 | 1 式 | `quantity` / `product_uom_id.name` | 量が 1 の場合も表示 |
| 明細: 単価（税抜） | ¥50,000 | `price_unit` | 税抜価格 |
| 明細: 税率 | 10% | `tax_ids.amount` | 複数税率は最初のみ表示（残りは別明細例外）|
| 明細: 金額（税抜） | ¥50,000 | `price_subtotal` | |
| 税率別内訳 | 10%対象 ¥5,000 ¥50,000 | `amount_by_group` | `tax_group_type` ごとに行生成 |
| 合計欄 | 小計 / 消費税 / 合計 | `amount_untaxed`, `amount_tax`, `amount_total` | |
| 備考欄 | テキスト | `acoona_invoice_footer_note or narration` | 1 段落にまとめる |

## 3. 色・フォント・寸法

| 項目 | 指定 |
| --- | --- |
| キーカラー | `#0F4CC6`（Primary）、`#F1F5FF`（薄い背景） |
| テキスト色 | 基本 `#222222`、白抜き部は `#FFFFFF` |
| フォント | 標準: `company_id.font`、和文フォールバック `"Noto Sans JP", "Hiragino Sans", sans-serif` |
| タイトル文字サイズ | 22pt | 
| 重要金額表示 | 24pt、太字 |
| 本文 | 10.5pt |
| 余白 | 上 12mm / 下 12mm / 左右 15mm |
| 表罫線 | 0.5pt、色 `#7B8EBE` |

## 4. 設定画面追加項目

`res.config.settings` で以下を編集可能にする。

1. 請求先敬称（デフォルト「御中」）。
2. 請求書リード文（例「下記の通り、ご請求申し上げます。」）。
3. 振込先複数設定（`res.partner.bank` のリストを並べ替えて使用）。
4. 振込手数料注意文（例「振込手数料は貴社でご負担ください。」）。
5. 備考欄初期値。

## 5. 実装タスク

1. **テンプレート改修**
   - `views/report_invoice_document_jp.xml` を新しい HTML 構造に差し替え。
   - サマリーブロック、明細グリッド、税率別表、合計ボックス、備考欄を QWeb で実装。
   - `static/src/scss/invoice_jp.scss` を新規作成し、テーマカラー・テーブルスタイルを定義。
2. **ヘルパーメソッド**
   - `account.move` に `get_jp_tax_summary()` を追加し、`amount_by_group` を税率区分・ラベル付き辞書へ整形。
   - 軽減税率フラグを判断するユーティリティ関数。
3. **設定フィールド**
   - `res.company` へ敬称、リード文、手数料文言、備考テンプレートを追加。
   - `res.config.settings` ビューで編集可能にし、既存 Acoona 項目と統合。
4. **翻訳**
   - `i18n/ja.po` に新規ラベルを追加。英語版も必要なら `en.po` を用意。
5. **テスト**
   - `tests/test_invoice_layout_jp.py` に `SavepointCase` で PDF レンダリングと表示値を検証するテストを実装。

## 6. バリデーション

- **必須値チェック**: `company_id.l10n_jp_registration_number` が未入力の場合、警告メッセージを PDF に赤字で表示。
- **税率別内訳**: 軽減税率（8%）と標準税率（10%）が同時に存在する請求書で集計が正しいか確認。
- **数量・単位**: 単位が未設定の場合は `―` を表示し、配列崩れを防ぐ。
- **複数振込口座**: 設定された口座が複数ある場合は表形式で縦並び表示。未設定ならブロック全体を折りたたむ。

## 7. 今後の拡張余地

- ロゴと社印を個別レイヤーで重ねる設定（社印の位置・サイズ調整 UI）。
- 英語併記モード（国際取引用）の追加。
- 領収書／納品書とのレイアウト統一、および同一 PDF での複数ページ出力対応。

---
提供: Codex Agent（2025-10-13）
