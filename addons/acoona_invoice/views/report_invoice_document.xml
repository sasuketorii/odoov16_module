<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_invoice_document_acoona" inherit_id="account.report_invoice_document">
        <xpath expr="//div[@class='page']/h2" position="attributes">
            <attribute name="t-if">not o.company_id.acoona_invoice_use_jp_layout</attribute>
        </xpath>
        <xpath expr="//div[@class='page']/h2" position="after">
            <h2 t-if="o.company_id.acoona_invoice_use_jp_layout" class="acoona-invoice-title text-uppercase mb-4">
                <span>請求書</span>
                <small class="d-block text-muted">INVOICE</small>
            </h2>
        </xpath>

        <xpath expr="//div[@id='informations']" position="attributes">
            <attribute name="t-if">not o.company_id.acoona_invoice_use_jp_layout</attribute>
        </xpath>
        <xpath expr="//div[@id='informations']" position="after">
            <div id="acoona_invoice_header" t-if="o.company_id.acoona_invoice_use_jp_layout" class="row mt-4 mb-4 acoona-invoice-header">
                <t t-set="company" t-value="o.company_id"/>
                <div class="col-7">
                    <table class="table table-borderless table-sm mb-2">
                        <tbody>
                            <tr t-if="o.invoice_date or o.date">
                                <th class="text-nowrap">請求日</th>
                                <td>
                                    <span t-if="o.invoice_date" t-esc="o._acoona_invoice_format_date(o.invoice_date)"/>
                                    <span t-elif="o.date" t-esc="o._acoona_invoice_format_date(o.date)"/>
                                </td>
                            </tr>
                            <tr t-if="o.invoice_date_due">
                                <th class="text-nowrap">お支払期日</th>
                                <td t-esc="o._acoona_invoice_format_date(o.invoice_date_due)"/>
                            </tr>
                            <tr t-if="o.name and o.name != '/'">
                                <th class="text-nowrap">請求書番号</th>
                                <td><span t-field="o.name"/></td>
                            </tr>
                            <tr t-if="o.invoice_payment_ref">
                                <th class="text-nowrap">お客様参照番号</th>
                                <td><span t-field="o.invoice_payment_ref"/></td>
                            </tr>
                            <tr t-if="o.invoice_origin">
                                <th class="text-nowrap">関連ドキュメント</th>
                                <td><span t-field="o.invoice_origin"/></td>
                            </tr>
                            <tr t-if="o.invoice_payment_term_id">
                                <th class="text-nowrap">支払条件</th>
                                <td><span t-field="o.invoice_payment_term_id"/></td>
                            </tr>
                        </tbody>
                    </table>
                    <t t-if="o.company_id.acoona_invoice_payment_note">
                        <div class="small text-muted" t-field="o.company_id.acoona_invoice_payment_note"/>
                    </t>
                </div>
                <div class="col-5">
                    <div class="border rounded p-3 h-100">
                        <div class="small text-muted mb-2">御請求先</div>
                        <div class="h5 mb-1" t-esc="o._acoona_invoice_recipient_label()"/>
                        <div t-if="o.partner_id.zip" class="mb-1">
                            〒<span t-field="o.partner_id.zip"/>
                        </div>
                        <address class="mb-0" t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
                        <div t-if="o.partner_id.phone" class="mt-1">
                            TEL: <span t-field="o.partner_id.phone"/>
                        </div>
                        <div t-if="o.partner_id.email" class="mt-1">
                            E-mail: <span t-field="o.partner_id.email"/>
                        </div>
                        <t t-set="responsible_lines" t-value="o._acoona_invoice_responsible_lines()"/>
                        <div t-if="responsible_lines" class="mt-3">
                            <div class="small text-muted">お問い合わせ先</div>
                            <t t-foreach="responsible_lines" t-as="line">
                                <div t-esc="line"/>
                            </t>
                        </div>
                        <t t-if="o.partner_shipping_id and (o.partner_shipping_id != o.partner_id)">
                            <div class="mt-3">
                                <div class="small text-muted">納品先</div>
                                <div t-field="o.partner_shipping_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                            </div>
                        </t>
                    </div>
                    <div class="border rounded p-3 mt-3">
                        <div class="small text-muted mb-2">御請求元</div>
                        <div class="h5 mb-1" t-esc="company.partner_id.name or company.name"/>
                        <address class="mb-0" t-field="company.partner_id" t-options='{"widget": "contact", "fields": ["address"], "no_marker": True}'/>
                        <div t-if="company.phone" class="mt-1">
                            TEL: <span t-field="company.phone"/>
                        </div>
                        <div t-if="company.fax" class="mt-1">
                            FAX: <span t-field="company.fax"/>
                        </div>
                        <div t-if="company.email" class="mt-1">
                            E-mail: <span t-field="company.email"/>
                        </div>
                        <div t-if="company.website" class="mt-1">
                            Web: <span t-field="company.website"/>
                        </div>
                        <div t-if="company.l10n_jp_registration_number" class="mt-1">
                            登録番号: <span t-field="company.l10n_jp_registration_number"/>
                        </div>
                        <div t-if="company.vat" class="mt-1">
                            税番号: <span t-field="company.vat"/>
                        </div>
                        <t t-set="bank_info" t-value="o._get_jp_bank_info()"/>
                        <div t-if="bank_info" class="mt-3">
                            <div class="small text-muted">振込先</div>
                            <t t-foreach="bank_info.get('lines', [])" t-as="bank_line">
                                <div class="mb-1" t-esc="bank_line"/>
                            </t>
                            <div t-if="bank_info.get('note')" class="mt-2 small text-muted">
                                <span t-esc="bank_info['note']"/>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </xpath>

        <xpath expr="//div[@id='total']" position="before">
            <t t-if="o.company_id.acoona_invoice_use_jp_layout">
                <t t-set="tax_summary" t-value="o._get_jp_tax_summary()"/>
                <t t-if="tax_summary">
                    <div class="row mt-3">
                        <div class="col-12 col-md-6">
                            <table class="table table-bordered table-sm jp-invoice__tax-summary">
                                <thead>
                                    <tr>
                                        <th>税率区分</th>
                                        <th class="text-end">消費税</th>
                                        <th class="text-end">金額（税抜）</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="tax_summary" t-as="summary">
                                        <tr>
                                            <td t-esc="summary['name']"/>
                                            <td class="text-end">
                                                <span t-esc="summary['tax']" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                            </td>
                                            <td class="text-end">
                                                <span t-esc="summary['base']" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                            </td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </t>
            </t>
        </xpath>

        <xpath expr="//div[@id='total']" position="after">
            <t t-if="o.company_id.acoona_invoice_use_jp_layout and (o.narration or o.company_id.acoona_invoice_footer_note)">
                <div class="row mt-3">
                    <div class="col-12">
                        <strong>備考</strong>
                        <div class="border rounded p-3 mt-1">
                            <t t-if="o.narration">
                                <div t-field="o.narration"/>
                            </t>
                            <t t-if="o.company_id.acoona_invoice_footer_note">
                                <div t-field="o.company_id.acoona_invoice_footer_note"/>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </xpath>
    </template>
</odoo>
