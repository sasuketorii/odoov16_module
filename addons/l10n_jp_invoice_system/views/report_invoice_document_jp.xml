<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- 日本向け請求書テンプレート拡張
         - 明細に軽減税率対象の印を表示
         - 合計欄を税率ごとに表示（10%/8%）
    -->

    <!-- 請求書本文（account.report_invoice_document）を日本仕様で強化 -->
    <template id="report_invoice_document_jp" inherit_id="account.report_invoice_document">
        <!-- 明細の品目名の横に軽減税率印（※）を表示 -->
        <xpath expr="//table[hasclass('o_main_table')]//tbody//tr//td[1]" position="attributes">
            <attribute name="class" add="o_line_name" separator=" "/>
        </xpath>
        <xpath expr="//table[hasclass('o_main_table')]//tbody//tr//td[1]/*[self::span or self::div][1]" position="after">
            <span t-if="sum([1 for t in line.tax_ids if t.amount == 8]) &gt; 0" class="text-danger" style="margin-left: 4px;">※</span>
        </xpath>

        <!-- 合計欄の置換: 税率ごとの税抜合計と消費税額を表示 -->
        <xpath expr="//div[@id='total']" position="replace">
            <div id="total" class="row justify-content-end">
                <div class="col-5">
                    <table class="table table-sm" style="page-break-inside: avoid;">
                        <t t-set="total_base_10"
                           t-value="sum(line.price_subtotal for line in o.invoice_line_ids if any(t.amount == 10 for t in line.tax_ids))"/>
                        <t t-set="total_tax_10"
                           t-value="sum((line.price_total - line.price_subtotal) for line in o.invoice_line_ids if any(t.amount == 10 for t in line.tax_ids))"/>
                        <t t-set="total_base_8"
                           t-value="sum(line.price_subtotal for line in o.invoice_line_ids if any(t.amount == 8 for t in line.tax_ids))"/>
                        <t t-set="total_tax_8"
                           t-value="sum((line.price_total - line.price_subtotal) for line in o.invoice_line_ids if any(t.amount == 8 for t in line.tax_ids))"/>

                        <tr class="border-black o_subtotal">
                            <td><strong>税抜合計金額</strong></td>
                            <td class="text-right">
                                <span t-field="o.amount_untaxed"/>
                            </td>
                        </tr>

                        <t t-if="total_tax_10 != 0">
                            <tr>
                                <td><span class="text-nowrap">10%対象 税抜合計</span></td>
                                <td class="text-right">
                                    <span t-esc="total_base_10" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                            <tr>
                                <td><span class="text-nowrap">消費税額 (10%)</span></td>
                                <td class="text-right">
                                    <span t-esc="total_tax_10" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                        </t>

                        <t t-if="total_tax_8 != 0">
                            <tr>
                                <td><span class="text-nowrap">8%対象 税抜合計</span></td>
                                <td class="text-right">
                                    <span t-esc="total_base_8" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                            <tr>
                                <td><span class="text-nowrap">消費税額 (8%)</span></td>
                                <td class="text-right">
                                    <span t-esc="total_tax_8" t-options='{"widget": "monetary", "display_currency": o.currency_id}'/>
                                </td>
                            </tr>
                        </t>

                        <tr class="border-black o_total">
                            <td><strong>合計金額（税込）</strong></td>
                            <td class="text-right">
                                <span t-field="o.amount_total"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </xpath>

        <!-- 合計欄の下に銀行口座ブロック（お振込先）を表示 -->
        <xpath expr="//div[@id='total']" position="after">
            <t t-if="o.company_id.l10n_jp_show_bank_block">
                <t t-set="bank" t-value="o.l10n_jp_invoice_bank_id or o.company_id.l10n_jp_default_invoice_bank_id or (o.company_id.bank_ids and o.company_id.bank_ids[0])"/>
                <t t-if="bank">
                    <div class="row mt-3">
                        <div class="col-7"/>
                        <div class="col-5">
                            <strong>お振込先</strong>
                            <ul class="list-unstyled mb-0">
                                <li><span t-field="bank.bank_id"/></li>
                                <li>
                                    <t t-if="bank.bank_id and bank.bank_id.bic">
                                        <span>BIC/SWIFT: </span><span t-field="bank.bank_id.bic"/>
                                    </t>
                                </li>
                                <li><span t-esc="bank.acc_number"/></li>
                            </ul>
                        </div>
                    </div>
                </t>
            </t>
        </xpath>
    </template>
</odoo>
